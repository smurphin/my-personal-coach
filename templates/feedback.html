{% extends "base.html" %}

{% block title %}Generating Feedback...{% endblock %}

{% block content %}
<div id="feedback-container">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Latest AI Feedback</h1>
        <p class="text-brand-light-gray mt-1">Analyzing your recent training data...</p>
    </div>

    <div class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8 min-h-[300px]">
        <div class="flex flex-col items-center justify-center text-center py-10">
            <div class="loader"></div>
            <p class="mt-4 text-brand-light-gray text-lg">Your coach is analyzing your activities.</p>
            <p class="text-gray-400">This can take a minute or two.</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we're viewing a specific activity's feedback
        const pathParts = window.location.pathname.split('/');
        const activityId = pathParts[2]; // /feedback/123456 -> activityId = 123456
        
        // Build the API URL with activity_id if present
        let apiUrl = '/api/get-feedback';
        if (activityId && !isNaN(activityId)) {
            apiUrl += `?activity_id=${activityId}`;
        }
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('feedback-container');
                let newContent = '';

                // Build the inner content of the card based on the API response
                if (data.feedback_html) {
                    newContent = `
                        <article class="prose prose-invert max-w-none prose-p:text-lg">
                            ${data.feedback_html}
                        </article>
                    `;
                } else {
                    newContent = `
                        <article class="prose prose-invert max-w-none prose-p:text-lg">
                            <p>${data.message || 'No new activities to analyze.'}</p>
                        </article>
                    `;
                }
                
                // Now, inject the new content into the page, creating the final structure
                container.innerHTML = `
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-white">${activityId ? 'Activity Feedback' : 'Latest AI Feedback'}</h1>
                        <p class="text-brand-light-gray mt-1">An analysis of your recent training data.</p>
                    </div>
                    <div class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8">
                        ${newContent}
                    </div>
                    <div class="mt-8">
                        <a href="${activityId ? '/log' : '/dashboard'}" class="text-brand-blue hover:underline">‚Üê Back to ${activityId ? 'Coaching Log' : 'Dashboard'}</a>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error fetching feedback:', error);
                const container = document.getElementById('feedback-container');
                container.innerHTML = `<p class="text-red-400">An error occurred while generating feedback.</p>`;
            });
    });
</script>
{% endblock %}