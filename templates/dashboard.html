{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-white">Your Dashboard</h1>
    <p class="text-brand-light-gray mt-1">Here's your focus for this week.</p>
</div>

<div class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8 mb-8 min-h-[150px]">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-brand-blue">Weekly Focus</h2>
        <button id="refresh-summary-button" title="Refresh Weekly Focus" class="text-gray-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l1.903 1.903h-3.183a.75.75 0 1 0 0 1.5h4.992a.75.75 0 0 0 .75-.75V4.356a.75.75 0 0 0-1.5 0v3.18l-1.9-1.9A9 9 0 0 0 3.306 9.67a.75.75 0 1 0 1.45.388Zm15.408 3.352a.75.75 0 0 0-.919.53 7.5 7.5 0 0 1-12.548 3.364l-1.902-1.903h3.183a.75.75 0 0 0 0-1.5H2.984a.75.75 0 0 0-.75.75v4.992a.75.75 0 0 0 1.5 0v-3.18l1.9 1.9a9 9 0 0 0 15.059-4.035.75.75 0 0 0-.53-.918Z" clip-rule="evenodd" /></svg>
        </button>
    </div>
    
    <div id="weekly-summary-container">
        <div class="flex items-center justify-center pt-4">
            <div class="loader"></div>
        </div>
    </div>
</div>

<div id="garmin-container" class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8 mb-8">
    <h2 class="text-2xl font-bold text-brand-blue mb-4">Health & Recovery</h2>
    {% if garmin_connected %}
    <div class="flex items-center justify-center pt-4">
        <div class="loader"></div>
    </div>
    {% else %}
    <div class="text-center py-4">
        <p class="text-brand-light-gray mb-4">Connect your Garmin account to see your daily health and recovery stats with trend analysis.</p>
        <a href="/connections" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition">
            Connect Account
        </a>
    </div>
    {% endif %}
</div>


<div class="lg:flex lg:space-x-8">
    <div class="lg:w-1/2">
        <div class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8 mb-8">
            <h2 class="text-2xl font-bold text-brand-blue mb-4">This Week's Sessions</h2>
            <div class="prose prose-invert max-w-none">
                {{ current_week_plan | safe }}
            </div>
        </div>
    </div>

    <div class="lg:w-1/2">
        <div class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8">
            <h2 class="text-2xl font-bold text-brand-blue mb-4">Chat with your Coach</h2>
            <p class="text-brand-light-gray mb-4">
                Need to adjust your plan? Feeling tired? Have a question? Let your coach know.
            </p>
            <form action="/chat" method="post" onsubmit="showChatSpinner()">
                <textarea name="user_message" rows="3" class="w-full bg-brand-dark border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-brand-blue focus:border-brand-blue transition" placeholder="e.g., 'I had a really busy week and missed my long run. What should I do?'"></textarea>
                <div class="mt-4">
                    <button type="submit" class="bg-brand-blue text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-brand-blue-hover transition-transform transform hover:scale-105 duration-300 ease-in-out">
                        Send Message
                    </button>
                </div>
            </form>
        
            <div id="chat-interaction-container" class="mt-6 border-t border-brand-dark pt-6" {% if not user_message and not chat_response %}style="display: none;"{% endif %}>
                {% if user_message %}
                <div id="user-message-container" class="mb-4">
                    <h3 class="text-xl font-semibold text-white mb-2">Your Question:</h3>
                    <div id="user-message-content" class="prose prose-invert max-w-none">
                        <p>{{ user_message }}</p>
                    </div>
                </div>
                {% endif %}
                
                <div id="chat-response-container" {% if not chat_response %}style="display: none;"{% endif %}>
                    <h3 class="text-xl font-semibold text-white mb-2">Coach's Response:</h3>
                    <div id="chat-response-content" class="prose prose-invert max-w-none">
                         {% if chat_response %}{{ chat_response | safe }}{% endif %}
                    </div>
                </div>
            </div>
        
            <div id="chat-spinner-container" class="mt-6" style="display: none;">
                <div class="flex items-center justify-center pt-4"><div class="loader"></div></div>
            </div>
            
            <div class="mt-4 text-center">
                <form action="/clear_chat" method="post" onsubmit="return confirm('Are you sure you want to permanently delete your entire chat history?');">
                    <button type="submit" class="text-sm text-gray-400 hover:text-white hover:underline">Delete chat history</button>
                </form>
            </div>
        </div> 
    </div>
</div>

<script>
    function fetchWeeklySummary() {
        const container = document.getElementById('weekly-summary-container');
        container.innerHTML = '<div class="flex items-center justify-center pt-4"><div class="loader"></div></div>';

        fetch('/api/weekly-summary')
            .then(response => response.json())
            .then(data => {
                if (data.summary) {
                    container.innerHTML = `<p class="text-lg text-brand-light-gray">${data.summary}</p>`;
                } else {
                    container.innerHTML = `<p class="text-red-400">Could not load weekly summary.</p>`;
                }
            })
            .catch(error => {
                console.error('Error fetching weekly summary:', error);
                container.innerHTML = `<p class="text-red-400">An error occurred while loading the summary.</p>`;
            });
    }

    function fetchGarminSummary() {
    const container = document.getElementById('garmin-container');
    fetch('/api/garmin-summary')
        .then(response => {
            if (!response.ok) {
                throw new Error('No Garmin connection found.');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            const today = data.today;
            const trendData = data.trend_data;

            // Create the display with today's metrics and separate charts
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-brand-blue">Health & Recovery</h2>
                    <div class="flex items-center space-x-3">
                        ${data.cached ? '<span class="text-xs text-gray-400">ðŸ“Š Cached data</span>' : '<span class="text-xs text-green-400">âœ“ Fresh data</span>'}
                        <button onclick="refreshGarminData()" class="text-xs text-brand-blue hover:text-white transition-colors px-3 py-1 rounded border border-brand-blue" title="Refresh Garmin data (use sparingly)">
                            Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Today's Key Metrics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center mb-8">
                    <div class="bg-brand-dark rounded-lg p-4">
                        <p class="text-sm text-brand-light-gray">HRV Status</p>
                        <p class="text-2xl font-bold text-white">${today?.hrv_status || 'N/A'}</p>
                        ${today?.hrv_value ? `<p class="text-xs text-gray-400">${today.hrv_value} ms</p>` : ''}
                    </div>
                    <div class="bg-brand-dark rounded-lg p-4">
                        <p class="text-sm text-brand-light-gray">Sleep Score</p>
                        <p class="text-2xl font-bold text-white">${today?.sleep_score || 'N/A'}</p>
                    </div>
                    <div class="bg-brand-dark rounded-lg p-4">
                        <p class="text-sm text-brand-light-gray">Body Battery</p>
                        <p class="text-2xl font-bold text-white">${today?.body_battery_high || 'N/A'}</p>
                        <p class="text-xs text-gray-400">High: ${today?.body_battery_high || 'N/A'} | Low: ${today?.body_battery_low || 'N/A'}</p>
                    </div>
                    <div class="bg-brand-dark rounded-lg p-4">
                        <p class="text-sm text-brand-light-gray">Training Status</p>
                        <p class="text-2xl font-bold text-white">${today?.training_status || 'N/A'}</p>
                    </div>
                </div>

                <!-- Readiness Score -->
                <div class="bg-brand-dark rounded-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-white">Readiness to Perform</h3>
                        <div class="text-right">
                            <p class="text-3xl font-bold ${getReadinessColor(data.readiness_score)}">${data.readiness_score || 'N/A'}</p>
                            <p class="text-xs text-gray-400">out of 100</p>
                        </div>
                    </div>
                    <div class="w-full bg-brand-gray rounded-full h-3 mb-2">
                        <div class="${getReadinessBgColor(data.readiness_score)} h-3 rounded-full transition-all duration-500" style="width: ${data.readiness_score || 0}%"></div>
                    </div>
                    <p class="text-sm text-brand-light-gray">${getReadinessMessage(data.readiness_score)}</p>
                </div>

                <!-- Separate Trend Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-brand-dark rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-white mb-3">Sleep Quality</h3>
                        <div style="position: relative; height: 200px;">
                            <canvas id="sleepChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-brand-dark rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-white mb-3">Body Battery</h3>
                        <div style="position: relative; height: 200px;">
                            <canvas id="batteryChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-brand-dark rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-white mb-3">HRV (ms)</h3>
                        <div style="position: relative; height: 200px;">
                            <canvas id="hrvChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            // Prepare chart data
            const labels = trendData.map(d => {
                const dateObj = new Date(d.date);
                return dateObj.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
            });

            const sleepData = trendData.map(d => d.sleep_score);
            const bodyBatteryHighData = trendData.map(d => d.body_battery_high);
            const bodyBatteryLowData = trendData.map(d => d.body_battery_low);
            const hrvData = trendData.map(d => d.hrv_value);

            // Common chart options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.5,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#2E2F33',
                        titleColor: '#E0E0E0',
                        bodyColor: '#E0E0E0',
                        borderColor: '#00A9FF',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#9CA3AF',
                            font: {
                                family: 'Inter',
                                size: 10
                            },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#9CA3AF',
                            font: {
                                family: 'Inter'
                            }
                        }
                    }
                }
            };

            // Destroy existing charts if they exist
            if (window.sleepChart && typeof window.sleepChart.destroy === 'function') {
                window.sleepChart.destroy();
            }
            if (window.batteryChart && typeof window.batteryChart.destroy === 'function') {
                window.batteryChart.destroy();
            }
            if (window.hrvChart && typeof window.hrvChart.destroy === 'function') {
                window.hrvChart.destroy();
            }

            // Sleep Chart
            const sleepCtx = document.getElementById('sleepChart').getContext('2d');
            window.sleepChart = new Chart(sleepCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: sleepData,
                        borderColor: '#00A9FF',
                        backgroundColor: 'rgba(0, 169, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            min: 0,
                            max: 100,
                            ticks: {
                                ...commonOptions.scales.y.ticks,
                                stepSize: 25
                            }
                        }
                    }
                }
            });

            // Body Battery Chart (with range)
            const batteryCtx = document.getElementById('batteryChart').getContext('2d');
            window.batteryChart = new Chart(batteryCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'High',
                            data: bodyBatteryHighData,
                            borderColor: '#4ADE80',
                            backgroundColor: 'rgba(74, 222, 128, 0.1)',
                            tension: 0.4,
                            fill: '+1',
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Low',
                            data: bodyBatteryLowData,
                            borderColor: '#4ADE80',
                            backgroundColor: 'rgba(74, 222, 128, 0.3)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: {
                            display: true,
                            labels: {
                                color: '#E0E0E0',
                                font: {
                                    family: 'Inter',
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            min: 0,
                            max: 100,
                            ticks: {
                                ...commonOptions.scales.y.ticks,
                                stepSize: 25
                            }
                        }
                    }
                }
            });

            // HRV Chart
            const hrvCtx = document.getElementById('hrvChart').getContext('2d');
            window.hrvChart = new Chart(hrvCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: hrvData,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: commonOptions
            });

        })
        .catch(error => {
            container.innerHTML = `
                <h2 class="text-2xl font-bold text-brand-blue mb-4">Health & Recovery</h2>
                <div class="text-center py-4">
                    <p class="text-brand-light-gray mb-4">Connect your Garmin account to see your daily health and recovery stats with trend analysis.</p>
                    <a href="/connections" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition">
                        Connect Account
                    </a>
                </div>
            `;
        });
}

// Helper functions for readiness scoring
function getReadinessColor(score) {
    if (!score) return 'text-gray-400';
    if (score >= 80) return 'text-green-400';
    if (score >= 60) return 'text-yellow-400';
    return 'text-red-400';
}

function getReadinessBgColor(score) {
    if (!score) return 'bg-gray-600';
    if (score >= 80) return 'bg-green-500';
    if (score >= 60) return 'bg-yellow-500';
    return 'bg-red-500';
}

function getReadinessMessage(score) {
    if (!score) return 'Calculating readiness...';
    if (score >= 80) return 'Excellent! You\'re primed for a quality training session.';
    if (score >= 60) return 'Good. Moderate intensity work is appropriate today.';
    if (score >= 40) return 'Below optimal. Consider an easy day or active recovery.';
    return 'Low readiness. Prioritize rest and recovery today.';
}

    document.addEventListener('DOMContentLoaded', function() {
        // Debug: Check if garmin_connected is set
        console.log('Garmin connected:', {{ garmin_connected|tojson }});
        
        fetchWeeklySummary();
        {% if garmin_connected %}
        console.log('Fetching Garmin data...');
        fetchGarminSummary();
        {% else %}
        console.log('Garmin not connected, skipping fetch');
        {% endif %}

        const refreshButton = document.getElementById('refresh-summary-button');
        refreshButton.addEventListener('click', function() {
            fetch('/api/refresh-weekly-summary', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' || data.status === 'no_op') {
                        fetchWeeklySummary();
                    }
                })
                .catch(error => console.error('Error clearing cache:', error));
        });
    });

    function showChatSpinner() {
        const interactionContainer = document.getElementById('chat-interaction-container');
        const responseContainer = document.getElementById('chat-response-container');
        const responseContent = document.getElementById('chat-response-content');
        if (interactionContainer && responseContainer && responseContent) {
            responseContent.innerHTML = '<div class="flex items-center justify-center pt-4"><div class="loader"></div></div>';
            responseContainer.style.display = 'block';
            interactionContainer.style.display = 'block';
        }
    }
</script>

{% endblock %}