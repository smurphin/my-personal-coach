{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-white">Your Dashboard</h1>
    <p class="text-brand-light-gray mt-1">Here's your focus for this week.</p>
</div>

<div class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8 mb-8 min-h-[150px]">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-brand-blue">Weekly Focus</h2>
        <button id="refresh-summary-button" title="Refresh Weekly Focus" class="text-gray-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l1.903 1.903h-3.183a.75.75 0 1 0 0 1.5h4.992a.75.75 0 0 0 .75-.75V4.356a.75.75 0 0 0-1.5 0v3.18l-1.9-1.9A9 9 0 0 0 3.306 9.67a.75.75 0 1 0 1.45.388Zm15.408 3.352a.75.75 0 0 0-.919.53 7.5 7.5 0 0 1-12.548 3.364l-1.902-1.903h3.183a.75.75 0 0 0 0-1.5H2.984a.75.75 0 0 0-.75.75v4.992a.75.75 0 0 0 1.5 0v-3.18l1.9 1.9a9 9 0 0 0 15.059-4.035.75.75 0 0 0-.53-.918Z" clip-rule="evenodd" /></svg>
        </button>
    </div>
    
    <div id="weekly-summary-container">
        <div class="flex items-center justify-center pt-4">
            <div class="loader"></div>
        </div>
    </div>
</div>

<div id="garmin-container" class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8 mb-8">
    <h2 class="text-2xl font-bold text-brand-blue mb-4">Health & Recovery</h2>
    <div class="flex items-center justify-center pt-4">
        <div class="loader"></div>
    </div>
</div>


<div class="lg:flex lg:space-x-8">
    <div class="lg:w-1/2">
        <div class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8 mb-8">
            <h2 class="text-2xl font-bold text-brand-blue mb-4">This Week's Sessions</h2>
            <div class="prose prose-invert max-w-none">
                {{ current_week_plan | safe }}
            </div>
        </div>
    </div>

    <div class="lg:w-1/2">
        <div class="bg-brand-gray rounded-xl shadow-lg p-6 lg:p-8">
            <h2 class="text-2xl font-bold text-brand-blue mb-4">Chat with your Coach</h2>
            <p class="text-brand-light-gray mb-4">
                Need to adjust your plan? Feeling tired? Have a question? Let your coach know.
            </p>
            <form action="/chat" method="post" onsubmit="showChatSpinner()">
                <textarea name="user_message" rows="3" class="w-full bg-brand-dark border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-brand-blue focus:border-brand-blue transition" placeholder="e.g., 'I had a really busy week and missed my long run. What should I do?'"></textarea>
                <div class="mt-4">
                    <button type="submit" class="bg-brand-blue text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-brand-blue-hover transition-transform transform hover:scale-105 duration-300 ease-in-out">
                        Send Message
                    </button>
                </div>
            </form>
        
            <div id="chat-interaction-container" class="mt-6 border-t border-brand-dark pt-6" {% if not user_message and not chat_response %}style="display: none;"{% endif %}>
                {% if user_message %}
                <div id="user-message-container" class="mb-4">
                    <h3 class="text-xl font-semibold text-white mb-2">Your Question:</h3>
                    <div id="user-message-content" class="prose prose-invert max-w-none">
                        <p>{{ user_message }}</p>
                    </div>
                </div>
                {% endif %}
                
                <div id="chat-response-container" {% if not chat_response %}style="display: none;"{% endif %}>
                    <h3 class="text-xl font-semibold text-white mb-2">Coach's Response:</h3>
                    <div id="chat-response-content" class="prose prose-invert max-w-none">
                         {% if chat_response %}{{ chat_response | safe }}{% endif %}
                    </div>
                </div>
            </div>
        
            <div id="chat-spinner-container" class="mt-6" style="display: none;">
                <div class="flex items-center justify-center pt-4"><div class="loader"></div></div>
            </div>
            
            <div class="mt-4 text-center">
                <form action="/clear_chat" method="post" onsubmit="return confirm('Are you sure you want to permanently delete your entire chat history?');">
                    <button type="submit" class="text-sm text-gray-400 hover:text-white hover:underline">Delete chat history</button>
                </form>
            </div>
        </div> 
    </div>
</div>

<script>
    function fetchWeeklySummary() {
        const container = document.getElementById('weekly-summary-container');
        container.innerHTML = '<div class="flex items-center justify-center pt-4"><div class="loader"></div></div>';

        fetch('/api/weekly-summary')
            .then(response => response.json())
            .then(data => {
                if (data.summary) {
                    container.innerHTML = `<p class="text-lg text-brand-light-gray">${data.summary}</p>`;
                } else {
                    container.innerHTML = `<p class="text-red-400">Could not load weekly summary.</p>`;
                }
            })
            .catch(error => {
                console.error('Error fetching weekly summary:', error);
                container.innerHTML = `<p class="text-red-400">An error occurred while loading the summary.</p>`;
            });
    }

    function fetchGarminSummary() {
        const container = document.getElementById('garmin-container');
        fetch('/api/garmin-summary')
            .then(response => {
                if (!response.ok) {
                    throw new Error('No Garmin connection found.');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // --- FIX: Corrected paths to nested data ---
                const hrvStatus = data.hrv?.hrvSummary?.status;
                const sleepScore = data.sleep?.dailySleepDTO?.sleepScores?.overall?.value;
                
                // For Body Battery, we find the last reading in the array.
                const bodyBatteryData = Array.isArray(data.body_battery) && data.body_battery.length > 0
                    ? data.body_battery[data.body_battery.length - 1]
                    : null;
                const bodyBatteryCharged = bodyBatteryData?.charged;

                const trainingStatus = data.training_status?.trainingStatus;

                container.innerHTML = `
                    <h2 class="text-2xl font-bold text-brand-blue mb-4">Health & Recovery (Yesterday)</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                        <div>
                            <p class="text-sm text-brand-light-gray">HRV Status</p>
                            <p class="text-2xl font-bold text-white">${hrvStatus || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-brand-light-gray">Sleep Score</p>
                            <p class="text-2xl font-bold text-white">${sleepScore || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-brand-light-gray">Body Battery</p>
                            <p class="text-2xl font-bold text-white">${bodyBatteryCharged || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-brand-light-gray">Training Status</p>
                            <p class="text-2xl font-bold text-white">${trainingStatus || 'N/A'}</p>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                container.innerHTML = `
                    <h2 class="text-2xl font-bold text-brand-blue mb-4">Health & Recovery</h2>
                    <div class="text-center py-4">
                        <p class="text-brand-light-gray mb-4">Connect your Garmin account to see your daily health and recovery stats.</p>
                        <a href="{{ url_for('connections') }}" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition">
                            Connect Account
                        </a>
                    </div>
                `;
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetchWeeklySummary();
        fetchGarminSummary();

        const refreshButton = document.getElementById('refresh-summary-button');
        refreshButton.addEventListener('click', function() {
            fetch('/api/refresh-weekly-summary', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' || data.status === 'no_op') {
                        fetchWeeklySummary();
                    }
                })
                .catch(error => console.error('Error clearing cache:', error));
        });
    });

    function showChatSpinner() {
        const interactionContainer = document.getElementById('chat-interaction-container');
        const responseContainer = document.getElementById('chat-response-container');
        const responseContent = document.getElementById('chat-response-content');
        if (interactionContainer && responseContainer && responseContent) {
            responseContent.innerHTML = '<div class="flex items-center justify-center pt-4"><div class="loader"></div></div>';
            responseContainer.style.display = 'block';
            interactionContainer.style.display = 'block';
        }
    }
</script>

{% endblock %}