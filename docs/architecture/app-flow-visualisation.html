<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Personal Coach - Application Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        .legend {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .legend h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .legend-item {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
            vertical-align: middle;
            border-radius: 3px;
        }
        #diagram {
            text-align: center;
            margin: 20px 0;
        }
        .key-points {
            margin-top: 30px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 5px;
        }
        .key-points h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .key-points ul {
            margin: 10px 0;
        }
        .key-points li {
            margin: 8px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>My Personal Coach - Application Architecture Flow</h1>
        <p class="subtitle">Comprehensive view of data flow, decision points, and AI integration</p>
        
        <div class="legend">
            <h3>Color Legend</h3>
            <div class="legend-item">
                <span class="legend-color" style="background: #98FB98;"></span>
                <span>User Onboarding</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #90EE90;"></span>
                <span>Weekly Summary Generation</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #87CEEB;"></span>
                <span>AI Processing (Analysis/Plans/Chat)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #FFD700;"></span>
                <span>Storage Decision Points</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #FFA500;"></span>
                <span>Garmin API Integration</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #DDA0DD;"></span>
                <span>Context Preparation/Analysis</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #FF6B6B;"></span>
                <span>Recovery Concerns Check</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #FFB6C1;"></span>
                <span>Plan Archival</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #E6E6FA;"></span>
                <span>Chat Interaction</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #FFA07A;"></span>
                <span>Plan Updates/Adaptation</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #F0E68C;"></span>
                <span>Historical Context</span>
            </div>
        </div>

        <div id="diagram">
            <pre class="mermaid">
flowchart TB
    Start([User Access]) --> Auth{Authenticated?}
    
    Auth -->|No| StravaOAuth[Strava OAuth Flow]
    StravaOAuth --> StoreToken[Store Access Token<br/>in DynamoDB]
    StoreToken --> CheckOnboarding{First Time<br/>User?}
    
    CheckOnboarding -->|Yes| Onboarding[User Onboarding Flow]
    CheckOnboarding -->|No| Dashboard
    
    %% Onboarding Flow
    Onboarding --> CollectInfo[Collect User Info:<br/>- Training Goals<br/>- Experience Level<br/>- Race Targets<br/>- Available Training Time]
    CollectInfo --> CalcZones{HR Zones<br/>Known?}
    CalcZones -->|No| EstimateZones[Estimate from<br/>Recent Activities]
    CalcZones -->|Yes| InputZones[User Inputs Zones]
    EstimateZones --> SetupProfile[Create User Profile]
    InputZones --> SetupProfile
    SetupProfile --> GenerateInitialPlan[Generate Initial<br/>Training Plan]
    
    GenerateInitialPlan --> FetchUserHistory[Fetch Recent<br/>Strava History]
    FetchUserHistory --> AssessBaseline[Assess Current Fitness:<br/>- Recent Volume<br/>- Intensity Distribution<br/>- Recovery Patterns]
    AssessBaseline --> PrepareOnboardingAI[Prepare AI Context:<br/>- User Goals<br/>- Current Fitness<br/>- Training Principles<br/>- Time Constraints]
    PrepareOnboardingAI --> GeminiPlanGen[Gemini AI:<br/>Generate Periodized Plan]
    GeminiPlanGen --> StructurePlan[Structure Plan:<br/>- Base/Build/Peak/Taper<br/>- Weekly Sessions<br/>- Progressive Overload<br/>- Recovery Weeks]
    StructurePlan --> StorePlan[Store Plan in DynamoDB]
    StorePlan --> Dashboard
    
    Auth -->|Yes| Dashboard[Dashboard View]
    
    %% Strava Webhook Flow
    StravaWebhook[Strava Webhook Event] --> ValidateWebhook{Valid Subscription<br/>Verification?}
    ValidateWebhook -->|Challenge| ReturnChallenge[Return Challenge]
    ValidateWebhook -->|Activity Event| ProcessWebhook[Process Activity Event]
    
    ProcessWebhook --> CheckEventType{Event Type?}
    CheckEventType -->|Create/Update| FetchActivity[Fetch Full Activity<br/>from Strava API]
    CheckEventType -->|Delete| RemoveActivity[Mark Activity Deleted]
    
    FetchActivity --> ExtractMetrics[Extract Key Metrics:<br/>- Distance, Duration<br/>- HR Zones, Pace<br/>- Elevation, Type]
    ExtractMetrics --> StoreActivity
    
    %% Data Storage Decision
    StoreActivity{Data Size Check} -->|< 300KB| SaveDynamoDB[Store in DynamoDB]
    StoreActivity -->|> 300KB| TrimAndArchive[Trim Data +<br/>Archive to S3]
    TrimAndArchive --> SaveDynamoDB
    SaveDynamoDB --> CheckWeekly{End of Week?}
    
    %% Weekly Summary Generation
    CheckWeekly -->|Yes| GenerateWeekly[Trigger Weekly<br/>Summary Generation]
    CheckWeekly -->|No| End1([End])
    
    GenerateWeekly --> FetchWeekData[Fetch Week's Activities<br/>from DynamoDB]
    FetchWeekData --> FetchGarminData{Garmin<br/>Connected?}
    
    FetchGarminData -->|Yes| CheckCache{Data Cached<br/>Today?}
    CheckCache -->|Yes| UseCachedGarmin[Use Cached Garmin Data]
    CheckCache -->|No| FetchGarminAPI[Fetch from Garmin API:<br/>- Sleep, HRV<br/>- Body Battery<br/>- Stress, Steps]
    
    FetchGarminAPI --> CacheGarmin[Cache Daily<br/>Garmin Data]
    CacheGarmin --> UseCachedGarmin
    FetchGarminData -->|No| SkipGarmin[Skip Garmin Data]
    
    UseCachedGarmin --> PrepareAIContext[Prepare AI Context]
    SkipGarmin --> PrepareAIContext
    
    %% AI Context Preparation
    PrepareAIContext --> IncludeBaseline[Include:<br/>- Training Philosophy<br/>- HR Zones, VDOT<br/>- Polarized Training]
    IncludeBaseline --> FetchHistoricalSummaries[Fetch Historical Context:<br/>- Past 4 Weekly Summaries<br/>- Last Plan Completion<br/>- Trend Data]
    FetchHistoricalSummaries --> IncludeWeekData[Include Week Data:<br/>- All Activities<br/>- Total Volume/TSS<br/>- HR Distribution]
    
    IncludeWeekData --> CheckActivePlan{Active Plan<br/>Exists?}
    CheckActivePlan -->|Yes| AddPlanContext[Add Plan Context:<br/>- Current Phase<br/>- Planned vs Actual<br/>- Adherence Rate<br/>- Upcoming Key Workouts]
    CheckActivePlan -->|No| IncludeGarminMetrics
    AddPlanContext --> IncludeGarminMetrics
    
    IncludeGarminMetrics{Garmin Data<br/>Available?}
    IncludeGarminMetrics -->|Yes| AddRecovery[Add Recovery Metrics:<br/>- Sleep Quality/Duration<br/>- HRV Trends<br/>- Body Battery<br/>- Stress Levels]
    IncludeGarminMetrics -->|No| SkipRecovery[Skip Recovery Data]
    
    AddRecovery --> CheckConcerns{Recovery<br/>Concerns?}
    SkipRecovery --> SendToGemini
    
    CheckConcerns -->|Yes| FlagConcerns[Flag Patterns:<br/>- Low Sleep<br/>- Declining HRV<br/>- High Stress<br/>- Low Body Battery]
    CheckConcerns -->|No| SendToGemini[Send to Gemini AI]
    FlagConcerns --> SendToGemini
    
    %% AI Processing
    SendToGemini --> GeminiAnalysis[Gemini AI Analysis:<br/>- Training Load<br/>- Recovery State<br/>- Zone Distribution<br/>- Recommendations]
    
    GeminiAnalysis --> GenerateSummary[Generate Weekly Summary:<br/>- Performance Analysis<br/>- Training Balance<br/>- Adaptation Guidance<br/>- Next Week Plan]
    
    GenerateSummary --> StoreSummary{Summary Size}
    StoreSummary -->|< 300KB| SaveSummaryDB[Store in DynamoDB]
    StoreSummary -->|> 300KB| ArchiveSummary[Archive Summary to S3<br/>+ Store Reference]
    ArchiveSummary --> SaveSummaryDB
    
    SaveSummaryDB --> DisplaySummary[Display on Dashboard]
    DisplaySummary --> End2([End])
    
    %% Dashboard Data Flow
    Dashboard --> LoadUserData[Load User Profile<br/>from DynamoDB]
    LoadUserData --> FetchRecentActivities[Fetch Recent Activities]
    FetchRecentActivities --> CheckS3Archive{Large Data<br/>in S3?}
    CheckS3Archive -->|Yes| FetchS3[Fetch from S3<br/>with Fallback]
    CheckS3Archive -->|No| UseDynamoDB[Use DynamoDB Data]
    FetchS3 --> MergeData[Merge Data Sources]
    UseDynamoDB --> MergeData
    
    MergeData --> FetchGarminDashboard{Fetch Garmin<br/>Metrics?}
    FetchGarminDashboard -->|Yes| CheckDailyCache{Cached<br/>Today?}
    CheckDailyCache -->|Yes| ShowCached[Show Cached Metrics]
    CheckDailyCache -->|No| FetchGarminLive[Fetch Live Garmin Data]
    FetchGarminLive --> UpdateCache[Update Daily Cache]
    UpdateCache --> ShowCached
    FetchGarminDashboard -->|No| SkipDashGarmin[Show Strava Only]
    
    ShowCached --> DisplayDashboard[Render Dashboard:<br/>- Recent Activities<br/>- Weekly Summary<br/>- Garmin Health Metrics<br/>- Training Trends]
    SkipDashGarmin --> DisplayDashboard
    DisplayDashboard --> End3([End])
    
    %% Plan Management Flow
    PlanRequest[User Requests<br/>New Plan] --> CheckExistingPlan{Active Plan<br/>Exists?}
    CheckExistingPlan -->|Yes| ConfirmReplace{Replace<br/>Existing?}
    ConfirmReplace -->|No| CancelRequest([Cancel])
    ConfirmReplace -->|Yes| ArchiveOldPlan[Archive Current Plan]
    CheckExistingPlan -->|No| StartNewPlan[Start Plan Generation]
    ArchiveOldPlan --> StartNewPlan
    
    StartNewPlan --> CollectPlanGoals[Collect Plan Details:<br/>- Race Date/Distance<br/>- Target Time<br/>- Training Days/Week<br/>- Key Constraints]
    CollectPlanGoals --> FetchCurrentFitness[Fetch Current Fitness:<br/>- Recent 4-8 weeks<br/>- Volume Trends<br/>- Best Performances]
    FetchCurrentFitness --> CalculateVDOT[Calculate VDOT<br/>from Recent Races]
    CalculateVDOT --> PreparePlanAI[Prepare AI Context:<br/>- User Profile & Zones<br/>- Current Fitness<br/>- Training History<br/>- Race Goals]
    PreparePlanAI --> GeminiPlanCreate[Gemini AI:<br/>Generate Custom Plan]
    GeminiPlanCreate --> PeriodizePlan[Create Periodization:<br/>- Phase Durations<br/>- Weekly Progression<br/>- Recovery Integration<br/>- Taper Schedule]
    PeriodizePlan --> StorePlanData{Plan Size}
    StorePlanData -->|< 300KB| SavePlanDB[Store in DynamoDB]
    StorePlanData -->|> 300KB| ArchivePlanS3[Archive to S3 +<br/>Store Reference]
    ArchivePlanS3 --> SavePlanDB
    SavePlanDB --> DisplayNewPlan[Display Plan<br/>to User]
    DisplayNewPlan --> PlanEnd([End])
    
    %% Plan Completion Flow
    PlanComplete[Plan End Date<br/>Reached] --> CheckCompletion{Plan<br/>Completed?}
    CheckCompletion -->|Yes| AnalyzePlanResults[Analyze Plan Outcomes]
    CheckCompletion -->|Partial| FlagIncomplete[Flag Incomplete Plan]
    
    AnalyzePlanResults --> CompareActualVsPlanned[Compare:<br/>- Planned vs Actual Volume<br/>- Session Completion Rate<br/>- Key Workout Results<br/>- Race Performance]
    FlagIncomplete --> CompareActualVsPlanned
    
    CompareActualVsPlanned --> FetchFinalMetrics[Fetch Final Metrics:<br/>- VDOT Change<br/>- Volume Progression<br/>- Recovery Trends<br/>- Performance Gains]
    FetchFinalMetrics --> GeminiPlanReview[Gemini AI:<br/>Plan Review & Analysis]
    GeminiPlanReview --> GenerateReport[Generate Completion Report:<br/>- Success Metrics<br/>- Lessons Learned<br/>- Recommendations<br/>- Next Steps]
    GenerateReport --> ArchivePlanComplete[Archive Completed Plan:<br/>- Move to S3<br/>- Add Completion Metadata<br/>- Link to Report]
    ArchivePlanComplete --> StoreArchiveRef[Update DynamoDB<br/>with Archive Reference]
    StoreArchiveRef --> PromptNextPlan{Continue<br/>Training?}
    PromptNextPlan -->|Yes| SuggestNextGoals[Suggest Next Goals<br/>Based on Progress]
    PromptNextPlan -->|No| MarkInactive[Mark User Inactive]
    SuggestNextGoals --> OfferPlanGen[Offer New<br/>Plan Generation]
    OfferPlanGen --> CompletionEnd([End])
    MarkInactive --> CompletionEnd
    
    %% Chat Interaction Flow
    UserChat[User Asks Question/<br/>Provides Feedback] --> LoadChatContext[Load Chat Context]
    LoadChatContext --> FetchUserProfile[Fetch User Profile<br/>& Current Plan]
    FetchUserProfile --> FetchRecentHistory[Fetch Recent:<br/>- Last 2 weeks activities<br/>- Latest summary<br/>- Recovery trends]
    FetchRecentHistory --> FetchHistoricalChat[Fetch Historical Context:<br/>- Past 4 summaries<br/>- Recent plan changes<br/>- Previous Q&A]
    FetchHistoricalChat --> AssembleChatContext[Assemble Full Context:<br/>- User profile/zones<br/>- Current plan status<br/>- Recent training<br/>- Recovery state<br/>- Historical summaries<br/>- Conversation history]
    AssembleChatContext --> SendChatToGemini[Send to Gemini AI]
    SendChatToGemini --> GeminiChatResponse[Generate Response:<br/>- Answer questions<br/>- Provide guidance<br/>- Suggest adjustments]
    GeminiChatResponse --> CheckPlanUpdate{Plan Update<br/>Needed?}
    CheckPlanUpdate -->|Yes| ProposeUpdate[Propose Plan Changes]
    CheckPlanUpdate -->|No| ReturnResponse[Return Response to User]
    ProposeUpdate --> UserApproves{User<br/>Approves?}
    UserApproves -->|Yes| UpdatePlan[Update Active Plan]
    UserApproves -->|No| ReturnResponse
    UpdatePlan --> LogChange[Log Plan Change:<br/>- Reason<br/>- Timestamp<br/>- Modified Sessions]
    LogChange --> ReturnResponse
    ReturnResponse --> ChatEnd([End])
    
    %% Plan Adaptation Flow
    WeeklySummaryComplete[Weekly Summary<br/>Generated] --> EvaluatePlanAdherence[Evaluate Plan Adherence:<br/>- Sessions completed<br/>- Volume vs target<br/>- Intensity adherence]
    EvaluatePlanAdherence --> CheckDeviations{Significant<br/>Deviations?}
    CheckDeviations -->|Yes| AnalyzeDeviations[Analyze Patterns:<br/>- Consistent under-training?<br/>- Over-reaching?<br/>- Missed key workouts?<br/>- Recovery issues?]
    CheckDeviations -->|No| ContinuePlan[Continue Current Plan]
    
    AnalyzeDeviations --> AssessRecovery[Assess Recovery State:<br/>- HRV trends<br/>- Sleep quality<br/>- Body Battery<br/>- Fatigue markers]
    AssessRecovery --> PrepareAdaptationContext[Prepare Adaptation Context:<br/>- Plan structure<br/>- Adherence data<br/>- Recovery state<br/>- Upcoming phases]
    PrepareAdaptationContext --> GeminiAdaptation[Gemini AI:<br/>Recommend Adaptations]
    GeminiAdaptation --> GenerateAdaptations[Generate Suggestions:<br/>- Volume adjustments<br/>- Intensity modifications<br/>- Recovery additions<br/>- Session swaps]
    GenerateAdaptations --> AutoApplyMinor{Minor<br/>Adjustments?}
    AutoApplyMinor -->|Yes| ApplyAutoUpdates[Auto-apply:<br/>- Small volume tweaks<br/>- Recovery day adds<br/>- Log in plan history]
    AutoApplyMinor -->|No| FlagForReview[Flag for User Review]
    ApplyAutoUpdates --> NotifyUser[Notify User of Changes]
    FlagForReview --> NotifyUser
    NotifyUser --> DisplayOnDashboard[Display on Dashboard<br/>with Rationale]
    DisplayOnDashboard --> AdaptationEnd([End])
    ContinuePlan --> AdaptationEnd
    
    %% Error Handling
    RemoveActivity --> End1
    ReturnChallenge --> End4([End])
    
    style GenerateWeekly fill:#90EE90
    style GeminiAnalysis fill:#87CEEB
    style StoreActivity fill:#FFD700
    style FetchGarminAPI fill:#FFA500
    style PrepareAIContext fill:#DDA0DD
    style CheckConcerns fill:#FF6B6B
    style Onboarding fill:#98FB98
    style GenerateInitialPlan fill:#87CEEB
    style GeminiPlanGen fill:#87CEEB
    style GeminiPlanCreate fill:#87CEEB
    style GeminiPlanReview fill:#87CEEB
    style ArchivePlanComplete fill:#FFB6C1
    style AnalyzePlanResults fill:#DDA0DD
    style UserChat fill:#E6E6FA
    style GeminiChatResponse fill:#87CEEB
    style AssembleChatContext fill:#DDA0DD
    style UpdatePlan fill:#FFA07A
    style EvaluatePlanAdherence fill:#DDA0DD
    style GeminiAdaptation fill:#87CEEB
    style ApplyAutoUpdates fill:#FFA07A
    style FetchHistoricalSummaries fill:#F0E68C
            </pre>
        </div>

        <div class="key-points">
            <h3>Key Architectural Decisions</h3>
            <ul>
                <li><strong>Historical Context Integration:</strong> All AI interactions include past 4 weekly summaries and last plan completion for continuity and context awareness</li>
                <li><strong>Chat Coaching:</strong> Conversational AI with full context (profile, plan, recent training, recovery, history, past Q&A) enables dynamic coaching and plan adjustments</li>
                <li><strong>Dynamic Plan Adaptation:</strong> Weekly evaluation of adherence triggers automatic minor adjustments or flags major changes for user review based on recovery and execution</li>
                <li><strong>User Onboarding:</strong> Collects training goals, estimates or inputs HR zones, analyzes recent Strava history, and generates initial AI-powered training plan</li>
                <li><strong>Plan Generation:</strong> Uses current fitness assessment, VDOT calculations, and Gemini AI to create periodized training plans with base/build/peak/taper phases</li>
                <li><strong>Plan Completion:</strong> Automated review compares actual vs planned training, analyzes outcomes, archives plan to S3, and suggests next goals based on progress</li>
                <li><strong>DynamoDB Size Management:</strong> Auto-trim when data exceeds 300KB (below 400KB limit), with S3 archival for large datasets</li>
                <li><strong>Garmin API Rate Limiting:</strong> Daily caching strategy prevents API throttling while maintaining data freshness</li>
                <li><strong>AI Context Assembly:</strong> Progressive data inclusion - baseline principles → historical summaries → activity data → plan context → recovery metrics → flagged concerns</li>
                <li><strong>Recovery Monitoring:</strong> Automated detection of concerning patterns (low sleep, declining HRV, high stress) before AI analysis</li>
                <li><strong>Data Flow Priority:</strong> S3 with DynamoDB fallback ensures reliability while optimizing for storage costs</li>
                <li><strong>Webhook Processing:</strong> Immediate extraction of key metrics from Strava data, storing only essential information</li>
            </ul>
        </div>

        <div class="key-points" style="background: #fff3cd;">
            <h3>Main Integration Points</h3>
            <ul>
                <li><strong>Strava:</strong> OAuth authentication, webhook subscriptions, activity data retrieval</li>
                <li><strong>Garmin:</strong> Sleep, HRV, Body Battery, stress metrics with daily caching</li>
                <li><strong>Gemini AI:</strong> Weekly analysis with full context (training philosophy, activities, recovery data)</li>
                <li><strong>Storage:</strong> DynamoDB for fast access, S3 for large/historical data with transparent fallback</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
            