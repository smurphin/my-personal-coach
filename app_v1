import os
import requests
from flask import Flask, request, redirect
from dotenv import load_dotenv

# Import the Google Cloud Vertex AI library
import vertexai
from vertexai.generative_models import GenerativeModel

# Load environment variables from .env file
load_dotenv()

app = Flask(__name__)

# --- Strava Configuration ---
STRAVA_CLIENT_ID = os.getenv("STRAVA_CLIENT_ID")
STRAVA_CLIENT_SECRET = os.getenv("STRAVA_CLIENT_SECRET")
STRAVA_AUTH_URL = "https://www.strava.com/oauth/authorize"
STRAVA_TOKEN_URL = "https://www.strava.com/oauth/token"
STRAVA_API_URL = "https://www.strava.com/api/v3"
REDIRECT_URI = "http://127.0.0.1:5000/callback"
SCOPES = "read,activity:read_all"

# --- Gemini/Vertex AI Configuration ---
# Your GCP Project ID, from your GCP Console
GCP_PROJECT_ID = "my-personal-coach-472007"
# Your GCP Region e.g. "us-central1"
GCP_LOCATION = "europe-west1"

# --- Initialize Vertex AI ---
# This automatically uses your GOOGLE_APPLICATION_CREDENTIALS from .env
vertexai.init(project=GCP_PROJECT_ID, location=GCP_LOCATION)

# Load the Gemini model using the correct model name for Vertex AI
model = GenerativeModel(model_name="gemini-2.0-flash")


@app.route("/")
def home():
    """Home page with a link to login."""
    return '<a href="/login" style="font-size: 24px;">Login with Strava to get AI summary of your last activity</a>'

@app.route("/login")
def login():
    """Redirects the user to Strava's authorization page."""
    auth_redirect_url = (
        f"{STRAVA_AUTH_URL}?client_id={STRAVA_CLIENT_ID}"
        f"&redirect_uri={REDIRECT_URI}"
        f"&response_type=code"
        f"&scope={SCOPES}"
    )
    return redirect(auth_redirect_url)


@app.route("/callback")
def callback():
    """
    Handles the redirect from Strava.
    Exchanges the auth code for a token.
    Fetches the latest activity.
    Sends it to Gemini for summary.
    """
    # 1. Exchange the authorization code for an access token
    auth_code = request.args.get('code')
    token_payload = {
        "client_id": STRAVA_CLIENT_ID,
        "client_secret": STRAVA_CLIENT_SECRET,
        "code": auth_code,
        "grant_type": "authorization_code",
    }
    try:
        response = requests.post(STRAVA_TOKEN_URL, data=token_payload)
        response.raise_for_status()
        token_data = response.json()
        access_token = token_data['access_token']
    except requests.exceptions.RequestException as e:
        return f"Error getting access token: {e}", 500

    # 2. Use the access token to fetch the latest activity
    headers = {'Authorization': f'Bearer {access_token}'}
    params = {'per_page': 1, 'page': 1}
    try:
        activities_response = requests.get(f"{STRAVA_API_URL}/athlete/activities", headers=headers, params=params)
        activities_response.raise_for_status()
        latest_activity = activities_response.json()[0]
    except (requests.exceptions.RequestException, IndexError) as e:
        return f"Error fetching Strava activity or no activities found: {e}", 500

    # 3. Prepare a prompt for Gemini with the activity data
    prompt = f"""
    You are an expert endurance running and triathlon coach. Analyze the following 6-week training summary for an athlete.

    Athlete PBs:
    - 5k: 19:34 (2025)
    - 10k: 39:53 (2021)
    - Marathon: 3:26 (2016)
    
    Last 6 Weeks Summary:
    - Average Weekly Running Distance: 30 km
    - Total Runs: 18
    - Longest Run: 25 km
    - High-Intensity Sessions: 6
    
    Based on this data, provide a concise summary of the athlete's current fitness level. 
    
    Identify their strengths (e.g., "strong endurance base") and suggest one or two areas to focus on for their next training block.

    Activity Name: {latest_activity.get('name')}
    Distance: {latest_activity.get('distance') / 1000:.2f} km
    Moving Time: {latest_activity.get('moving_time') / 60:.0f} minutes
    Average Heart Rate: {latest_activity.get('average_heartrate', 'N/A')} bpm
    """

    # 4. Send the prompt to Gemini and return the response
    try:
        gemini_response = model.generate_content(prompt)
        # Display the summary in the browser
        return f"""
        <h1>AI Summary of Your Last Activity</h1>
        <p style="font-size: 18px;">{gemini_response.text}</p>
        <hr>
        <h3>Raw Strava Data:</h3>
        <pre>{latest_activity}</pre>
        """
    except Exception as e:
        return f"Error generating content from Gemini: {e}", 500


if __name__ == "__main__":
    app.run(debug=True, port=5000)